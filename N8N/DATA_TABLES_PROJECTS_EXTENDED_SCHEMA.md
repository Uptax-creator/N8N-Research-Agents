# üìä DATA TABLES - PROJECTS EXTENDED SCHEMA

## üéØ OBJETIVO

Adicionar campos de configura√ß√£o GitHub √† tabela `projects` para permitir URLs vari√°veis por projeto, centralizando a configura√ß√£o de reposit√≥rios e caminhos base.

---

## üìã SCHEMA COMPLETO: `projects`

### **Campos Existentes (N√ÉO ALTERAR)**

| Campo | Tipo | Obrigat√≥rio | Descri√ß√£o |
|-------|------|-------------|-----------|
| id | number | Auto | Auto-incrementado pelo N8N |
| project_id | string | ‚úÖ | Identificador √∫nico (ex: project_001) |
| project_name | string | ‚úÖ | Nome do projeto |
| description | string | ‚ùå | Descri√ß√£o do projeto |
| owner_email | string | ‚ùå | Email do respons√°vel |
| status | string | ‚úÖ | active, inactive, archived |
| created_at | datetime | ‚úÖ | Data de cria√ß√£o |
| updated_at | datetime | ‚ùå | Data de atualiza√ß√£o |

### **Campos NOVOS (Adicionar no N8N UI)**

| Campo | Tipo | Obrigat√≥rio | Descri√ß√£o | Exemplo |
|-------|------|-------------|-----------|---------|
| **repository_url** | string | ‚úÖ | URL base do reposit√≥rio GitHub | `https://github.com/Uptax-creator/N8N-Research-Agents` |
| **branch** | string | ‚úÖ | Branch ativa do reposit√≥rio | `clean-deployment` |
| **code_base_path** | string | ‚úÖ | Caminho dos c√≥digos (loaders/processors) | `N8N/code/` |
| **prompts_base_path** | string | ‚úÖ | Caminho dos prompts | `N8N/prompts/agents/` |
| **agents_base_path** | string | ‚úÖ | Caminho dos agents (configs) | `N8N/agents/` |
| **projects_base_path** | string | ‚úÖ | Caminho dos projects | `N8N/projects/` |

---

## üéØ VANTAGENS

### **1. URLs Vari√°veis por Projeto**
```javascript
// Projeto 1: Produ√ß√£o
{
  "project_id": "project_001",
  "repository_url": "https://github.com/Uptax-creator/N8N-Research-Agents",
  "branch": "clean-deployment"
}

// Projeto 2: Desenvolvimento
{
  "project_id": "project_002",
  "repository_url": "https://github.com/Uptax-creator/N8N-Research-Agents",
  "branch": "development"
}

// Projeto 3: Outro reposit√≥rio
{
  "project_id": "project_003",
  "repository_url": "https://github.com/AnotherOrg/Another-Repo",
  "branch": "main"
}
```

### **2. Centraliza√ß√£o de Configura√ß√£o**
- ‚úÖ Mudar branch uma vez afeta todos agents do projeto
- ‚úÖ Migrar para novo reposit√≥rio sem alterar agents
- ‚úÖ Frontend n√£o precisa saber caminhos GitHub
- ‚úÖ Menos erros de URL hardcoded

### **3. Auto-gera√ß√£o de URLs**
```javascript
// Componente busca projeto
const project = await $.getDataTableRows('projects', {
  filter: { project_id: 'project_001' }
})[0];

// Monta URL base
const baseUrl = `${project.repository_url}/raw/${project.branch}`;

// Gera URLs automaticamente
const configUrl = `${baseUrl}/${project.agents_base_path}agent_004/config.json`;
const promptsUrl = `${baseUrl}/${project.prompts_base_path}agent_004_prompts.json`;

// Resultado:
// https://github.com/Uptax-creator/N8N-Research-Agents/raw/clean-deployment/N8N/agents/agent_004/config.json
// https://github.com/Uptax-creator/N8N-Research-Agents/raw/clean-deployment/N8N/prompts/agents/agent_004_prompts.json
```

---

## üìÑ DADOS INICIAIS

### **project_001 (ATUALIZADO)**

```json
{
  "project_id": "project_001",
  "project_name": "UptaxDev Multi-Agent System",
  "description": "Sistema multi-agente para pesquisa e an√°lise fiscal",
  "owner_email": "kleber.ribeiro@uptax.net",
  "status": "active",

  "repository_url": "https://github.com/Uptax-creator/N8N-Research-Agents",
  "branch": "clean-deployment",
  "code_base_path": "N8N/code/",
  "prompts_base_path": "N8N/prompts/agents/",
  "agents_base_path": "N8N/agents/",
  "projects_base_path": "N8N/projects/",

  "created_at": "2025-01-15T10:00:00.000Z",
  "updated_at": "2025-10-07T10:00:00.000Z"
}
```

---

## üîß GUIA DE ATUALIZA√á√ÉO NO N8N UI

### **Passo 1: Adicionar Colunas**
1. Abrir N8N ‚Üí Data Tables ‚Üí `projects`
2. Clicar em **Edit Table**
3. Adicionar 6 novas colunas:

| Nome | Tipo | Obrigat√≥rio |
|------|------|-------------|
| repository_url | string | Sim |
| branch | string | Sim |
| code_base_path | string | Sim |
| prompts_base_path | string | Sim |
| agents_base_path | string | Sim |
| projects_base_path | string | Sim |

4. Salvar altera√ß√µes

### **Passo 2: Atualizar Registro project_001**
1. Localizar registro `project_001`
2. Clicar em **Edit**
3. Preencher novos campos:
   - **repository_url:** `https://github.com/Uptax-creator/N8N-Research-Agents`
   - **branch:** `clean-deployment`
   - **code_base_path:** `N8N/code/`
   - **prompts_base_path:** `N8N/prompts/agents/`
   - **agents_base_path:** `N8N/agents/`
   - **projects_base_path:** `N8N/projects/`
4. Atualizar campo `updated_at` com data atual
5. Salvar

---

## üìä INTEGRA√á√ÉO COM COMPONENTES

### **agent-data-mapper.js (Atualizado)**

```javascript
/**
 * Busca configura√ß√µes do projeto e auto-gera URLs GitHub
 */
async function mapAgentData(body, $ = null) {
  const data = body.data || body;

  // Valida√ß√µes obrigat√≥rias
  if (!data.agent_id) throw new Error('Missing required field: agent_id');
  if (!data.project_id) throw new Error('Missing required field: project_id');
  if (!data.agent_type) throw new Error('Missing required field: agent_type');

  // ‚úÖ BUSCAR CONFIGURA√á√ïES DO PROJETO
  if ($) {
    const projects = await $.getDataTableRows('projects');
    const project = projects.find(p => p.project_id === data.project_id);

    if (!project) {
      throw new Error(`Project ${data.project_id} not found in Data Tables`);
    }

    // ‚úÖ AUTO-GERAR URLs do GitHub
    const baseUrl = `${project.repository_url}/raw/${project.branch}`;

    data.github_config_url = `${baseUrl}/${project.agents_base_path}${data.agent_id}/config.json`;
    data.github_prompts_url = `${baseUrl}/${project.prompts_base_path}${data.agent_id}_prompts.json`;

    console.log(`‚úÖ URLs auto-generated from project: ${project.project_id}`);
    console.log(`   Config: ${data.github_config_url}`);
    console.log(`   Prompts: ${data.github_prompts_url}`);
  }

  // Mapear dados
  const mapped = {
    agent_id: data.agent_id.trim(),
    project_id: data.project_id.trim(),
    agent_name: data.agent_name?.trim() || data.agent_id,
    agent_type: data.agent_type.trim(),
    description: data.description?.trim() || '',

    // URLs auto-geradas
    github_config_url: data.github_config_url,
    github_prompts_url: data.github_prompts_url,

    // Campos opcionais
    workflow_id: data.workflow_id?.trim() || null,
    webhook_id: data.webhook_id?.trim() || null,
    webhook_url: data.webhook_url?.trim() || null,

    // Soft Delete
    is_latest: true,
    version: data.version || 1,
    status: 'active',
    deleted_at: null,
    superseded_by: null,

    // Timestamps
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  };

  return mapped;
}
```

---

## üéØ COMPONENTES NECESS√ÅRIOS

### **1. project-data-mapper.js (INSERT)**

```javascript
/**
 * Project Data Mapper - INSERT
 * Mapeia dados do webhook para tabela projects
 */
async function mapProjectData(body, $ = null) {
  const data = body.data || body;

  // Valida√ß√µes obrigat√≥rias
  if (!data.project_id) throw new Error('Missing required field: project_id');
  if (!data.project_name) throw new Error('Missing required field: project_name');
  if (!data.repository_url) throw new Error('Missing required field: repository_url');
  if (!data.branch) throw new Error('Missing required field: branch');

  // ‚úÖ VALIDA√á√ÉO: Projeto j√° existe?
  if ($) {
    const projects = await $.getDataTableRows('projects');
    const exists = projects.find(p => p.project_id === data.project_id);

    if (exists) {
      const error = new Error(`Project ${data.project_id} already exists (id=${exists.id})`);
      error.constraint_violation = 'DUPLICATE_PROJECT_ID';
      error.existing_project = exists;
      throw error;
    }
  }

  // Valida√ß√£o URL
  if (!data.repository_url.startsWith('https://github.com/')) {
    throw new Error('Invalid repository_url: must be a GitHub HTTPS URL');
  }

  // Mapear dados
  const mapped = {
    project_id: data.project_id.trim(),
    project_name: data.project_name.trim(),
    description: data.description?.trim() || '',
    owner_email: data.owner_email?.trim() || null,
    status: data.status || 'active',

    // GitHub Config
    repository_url: data.repository_url.trim(),
    branch: data.branch.trim(),
    code_base_path: data.code_base_path?.trim() || 'N8N/code/',
    prompts_base_path: data.prompts_base_path?.trim() || 'N8N/prompts/agents/',
    agents_base_path: data.agents_base_path?.trim() || 'N8N/agents/',
    projects_base_path: data.projects_base_path?.trim() || 'N8N/projects/',

    // Timestamps
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  };

  console.log(`‚úÖ Project data mapped: ${mapped.project_id}`);
  return mapped;
}

// Export
if (typeof module !== 'undefined' && module.exports) {
  module.exports = { mapProjectData };
}

// Auto-execu√ß√£o
if (typeof $ !== 'undefined') {
  const inputData = $input.all()[0].json;
  return mapProjectData(inputData, $);
}
```

### **2. project-query-helper.js (GET)**

```javascript
/**
 * Project Query Helper - GET
 * Busca projetos na Data Table com filtros
 */
async function getProject($, project_id) {
  try {
    const allProjects = await $.getDataTableRows('projects');

    const project = allProjects.find(p => p.project_id === project_id);

    if (!project) {
      return {
        found: false,
        message: `‚ùå Project ${project_id} not found`,
        project: null
      };
    }

    return {
      found: true,
      message: `‚úÖ Project ${project_id} found`,
      project: project
    };

  } catch (error) {
    return {
      found: false,
      error: true,
      message: `‚ùå Query failed: ${error.message}`,
      project: null
    };
  }
}

/**
 * Lista todos os projetos ativos
 */
async function listActiveProjects($) {
  try {
    const allProjects = await $.getDataTableRows('projects');
    const activeProjects = allProjects.filter(p => p.status === 'active');

    return {
      success: true,
      total: activeProjects.length,
      projects: activeProjects
    };

  } catch (error) {
    return {
      success: false,
      error: error.message,
      projects: []
    };
  }
}

/**
 * Monta URL base do GitHub para um projeto
 */
function buildGitHubBaseUrl(project) {
  return `${project.repository_url}/raw/${project.branch}`;
}

/**
 * Monta URL completa para config de agent
 */
function buildAgentConfigUrl(project, agent_id) {
  const baseUrl = buildGitHubBaseUrl(project);
  return `${baseUrl}/${project.agents_base_path}${agent_id}/config.json`;
}

/**
 * Monta URL completa para prompts de agent
 */
function buildAgentPromptsUrl(project, agent_id) {
  const baseUrl = buildGitHubBaseUrl(project);
  return `${baseUrl}/${project.prompts_base_path}${agent_id}_prompts.json`;
}

// Export
if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    getProject,
    listActiveProjects,
    buildGitHubBaseUrl,
    buildAgentConfigUrl,
    buildAgentPromptsUrl
  };
}

// Auto-execu√ß√£o
if (typeof $ !== 'undefined') {
  const inputData = $input.all()[0].json;
  const project_id = inputData.project_id;
  return getProject($, project_id);
}
```

---

## üìö ENDPOINTS FRONTEND ‚Üí N8N

### **1. Listar Projetos**
```
GET /webhook/list-projects
Response: { projects: [...] }
```

### **2. Buscar Projeto**
```
GET /webhook/get-project?project_id=project_001
Response: { found: true, project: {...} }
```

### **3. Criar Projeto**
```
POST /webhook/create-project
Body: {
  "project_id": "project_002",
  "project_name": "Projeto Teste",
  "repository_url": "https://github.com/...",
  "branch": "development"
}
Response: { success: true, project: {...} }
```

---

## ‚úÖ CHECKLIST DE IMPLEMENTA√á√ÉO

### **Fase 1: Atualizar Data Table (30min)**
- [ ] Adicionar 6 colunas na tabela `projects`
- [ ] Atualizar registro `project_001` com valores
- [ ] Validar dados salvos

### **Fase 2: Criar Componentes (1h)**
- [ ] Criar `project-data-mapper.js`
- [ ] Criar `project-query-helper.js`
- [ ] Atualizar `agent-data-mapper.js`
- [ ] Commit no GitHub

### **Fase 3: Workflows (1h)**
- [ ] Workflow: List Projects
- [ ] Workflow: Get Project
- [ ] Workflow: Create Project
- [ ] Workflow: Create Agent (com auto-gera√ß√£o de URLs)

### **Fase 4: Testes (30min)**
- [ ] Testar busca de projeto
- [ ] Testar cria√ß√£o de agent com URLs auto-geradas
- [ ] Validar URLs funcionando

---

## üìä DIAGRAMA DE FLUXO

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FRONTEND   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ POST /create-agent
       ‚îÇ { agent_id, project_id, agent_type }
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  N8N WORKFLOW: Create Agent         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                     ‚îÇ
‚îÇ  Node 1: Webhook                    ‚îÇ
‚îÇ    ‚Üì                                ‚îÇ
‚îÇ  Node 2: Get Project (query-helper)‚îÇ
‚îÇ    ‚Üì                                ‚îÇ
‚îÇ  Node 3: Agent Data Mapper          ‚îÇ
‚îÇ    ‚îú‚îÄ Busca project config          ‚îÇ
‚îÇ    ‚îú‚îÄ Auto-gera github_config_url   ‚îÇ
‚îÇ    ‚îî‚îÄ Auto-gera github_prompts_url  ‚îÇ
‚îÇ    ‚Üì                                ‚îÇ
‚îÇ  Node 4: Insert Agent (Data Table)  ‚îÇ
‚îÇ    ‚Üì                                ‚îÇ
‚îÇ  Node 5: Response                   ‚îÇ
‚îÇ                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ DATA TABLES ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  projects   ‚îÇ ‚Üê Configura√ß√£o GitHub
‚îÇ  agents     ‚îÇ ‚Üê URLs auto-geradas
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ RESULTADO FINAL

**Frontend envia:**
```json
{
  "agent_id": "agent_004",
  "project_id": "project_001",
  "agent_type": "tax_calculator",
  "agent_name": "Tax Calculator"
}
```

**Agent criado automaticamente com:**
```json
{
  "agent_id": "agent_004",
  "project_id": "project_001",
  "agent_name": "Tax Calculator",
  "agent_type": "tax_calculator",
  "github_config_url": "https://github.com/Uptax-creator/N8N-Research-Agents/raw/clean-deployment/N8N/agents/agent_004/config.json",
  "github_prompts_url": "https://github.com/Uptax-creator/N8N-Research-Agents/raw/clean-deployment/N8N/prompts/agents/agent_004_prompts.json",
  "status": "active",
  "is_latest": true,
  "version": 1
}
```

‚úÖ **URLs vari√°veis, gerenciadas centralmente, zero hardcode!**
